<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/docusaurus/blog/rss.xml" title="Personal Research &amp; Development Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docusaurus/blog/atom.xml" title="Personal Research &amp; Development Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Personal Research &amp; Development" href="/docusaurus/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">Landing Control | Personal Research &amp; Development</title><meta data-react-helmet="true" property="og:url" content="https://matthewoots.github.io/docusaurus/docs/px4-autopilot/fixedwing/land"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Landing Control | Personal Research &amp; Development"><meta data-react-helmet="true" name="description" content="Overview"><meta data-react-helmet="true" property="og:description" content="Overview"><link data-react-helmet="true" rel="shortcut icon" href="/docusaurus/img/logo.png"><link data-react-helmet="true" rel="canonical" href="https://matthewoots.github.io/docusaurus/docs/px4-autopilot/fixedwing/land"><link data-react-helmet="true" rel="alternate" href="https://matthewoots.github.io/docusaurus/docs/px4-autopilot/fixedwing/land" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://matthewoots.github.io/docusaurus/docs/px4-autopilot/fixedwing/land" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://HXJSB0I3EO-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/docusaurus/assets/css/styles.6c532ff6.css">
<link rel="preload" href="/docusaurus/assets/js/runtime~main.be60e350.js" as="script">
<link rel="preload" href="/docusaurus/assets/js/main.715702e2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docusaurus/"><img src="/docusaurus/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docusaurus/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Main</b></a><a class="navbar__item navbar__link" href="/docusaurus/docs/px4-autopilot/introduction/intro">PX4-Autopilot</a><a class="navbar__item navbar__link" href="/docusaurus/docs/motion-planning/introduction/intro">Motion-Planning</a><a class="navbar__item navbar__link" href="/docusaurus/docs/gazebo/introduction/intro">Gazebo</a><a class="navbar__item navbar__link" href="/docusaurus/docs/unity/introduction/intro">Unity3D</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docusaurus/docs/Docusaurus/intro">Docs</a><a class="navbar__item navbar__link" href="/docusaurus/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/matthewoots" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/docusaurus/"><img src="/docusaurus/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docusaurus/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Main</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docusaurus/docs/px4-autopilot/introduction/intro">PX4-Autopilot</a></li><li class="menu__list-item"><a class="menu__link" href="/docusaurus/docs/motion-planning/introduction/intro">Motion-Planning</a></li><li class="menu__list-item"><a class="menu__link" href="/docusaurus/docs/gazebo/introduction/intro">Gazebo</a></li><li class="menu__list-item"><a class="menu__link" href="/docusaurus/docs/unity/introduction/intro">Unity3D</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docusaurus/docs/Docusaurus/intro">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docusaurus/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/matthewoots" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docusaurus/docs/px4-autopilot/introduction/intro">Introduction</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Fixed-Wing Controller</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docusaurus/docs/px4-autopilot/fixedwing/land">Landing Control</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">Landing Control</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The overview can be seen in <code>PX4.io</code> official documentation on <code>Fixed Wing Landing</code> and the documentation can be found <a href="https://docs.px4.io/v1.12/en/flying/fixed_wing_landing.html" target="_blank" rel="noopener noreferrer">here</a> </p></div></div><p>PX4 enables <strong>autopilot-controlled fixed-wing (FW) landing</strong> in <strong>Missions</strong> mode, <strong>Land</strong> mode and <strong>Return</strong> mode.</p><p>The landing logic has several phases, as shown below. In the first phase the vehicle will follow a fixed trajectory (<strong>FW_LND_ANG</strong>) towards the ground. At the flare landing altitude (<strong>FW_LND_FLALT</strong>) the vehicle will start to follow a flare path (the curve is based on the value of <strong>FW_LND_HVIRT</strong>).</p><p><img alt="Fixed Wing Landing Path" src="/docusaurus/assets/images/fw_landing_path-a1df1b58a0d422ee30986d1424aa157d.png"></p><p>The flare landing altitude is relative to the altitude that the FW vehicle &quot;<strong>thinks</strong>&quot; is ground level. In <strong>Land mode</strong> the ground altitude is not known and the vehicle will use assume it is at 0m (<strong>sea level</strong>). Often the ground level will be much higher than sea level, so the vehicle will land in the <strong>first phase</strong> (<strong>it will land on the ground before it reaches the flare altitude</strong>).</p><table><thead><tr><th align="center">Parameter</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center"><strong><font color="LightGreen"> FW_LND_ANG </font></strong></td><td align="center">Landing slope angle prior to flaring</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_HVIRT </font></strong></td><td align="center">Virtual horizontal line/altitude used to calculate the flare trajectory. This represents the sub-ground altitude that the flare-path curve asymptotically approaches.</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_HVIRT </font></strong></td><td align="center">Virtual horizontal line/altitude used to calculate the flare trajectory. This represents the sub-ground altitude that the flare-path curve asymptotically approaches.</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_FLALT </font></strong></td><td align="center">Landing flare altitude (relative to landing altitude)</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_TLALT </font></strong></td><td align="center">Landing throttle limit altitude (relative landing altitude). The default value of -1.0 lets the system default to applying throttle limiting at 2/3 of the flare altitude.</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_HHDIST </font></strong></td><td align="center">Landing heading hold horizontal distance</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_USETER </font></strong></td><td align="center">Use terrain estimate (ground altitude from GPS) during landing. This is turned off by default and a waypoint or return altitude is normally used (or sea level for an arbitrary land position).</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_FL_PMIN </font></strong></td><td align="center">Minimum pitch during flare. A positive sign means nose up Applied once FW_LND_TLALT is reached</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_FL_PMAX </font></strong></td><td align="center">Maximum pitch during flare. A positive sign means nose up Applied once FW_LND_TLALT is reached</td></tr><tr><td align="center"><strong><font color="LightGreen"> FW_LND_AIRSPD_SC </font></strong></td><td align="center">Min. airspeed scaling factor for landing. Comment: Multiplying this factor with the minimum airspeed of the plane gives the target airspeed the landing approach. <code>FW_AIRSPD_MIN x FW_LND_AIRSPD_SC</code></td></tr></tbody></table><p>Sample values for FW with changed values being highlighted in <strong><font color="red"> RED </font></strong> :</p><table><thead><tr><th><img src="/docusaurus/assets/images/landing_params-f2d6008c2636b6391865896839cd916e.png"></th></tr></thead></table><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="code-review"></a>Code Review<a class="hash-link" href="#code-review" title="Direct link to heading">#</a></h2><p>Function in <code>FixedwingPositionControl.cpp</code>, this is called when <code>commander land</code> is used in the <strong>mav console</strong> which will switch the <code>position_sp_type</code> to <strong>4</strong> which refers to <code>SETPOINT_TYPE_LAND (4)</code> where default is <strong>2</strong> <code>SETPOINT_TYPE_LOITER (2)</code>. This is becasue the UAV is always going to loiter around the waypoint. you can find the different modes under the UORB message <code>position_setpoint</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">FixedwingPositionControl</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">control_landing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> hrt_abstime </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">now</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Vector2d </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">curr_pos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Vector2f </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ground_speed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> position_setpoint_s </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pos_sp_prev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> position_setpoint_s </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pos_sp_curr</span><span class="token punctuation" style="color:#393A34">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="findings"></a>Findings<a class="hash-link" href="#findings" title="Direct link to heading">#</a></h2><ul><li><p>Apparently after checking normally <code>!pos_sp_prev.valid</code> meaning that there is no <code>pos_sp.valid</code> and the current <code>lat</code> and <code>long</code> is used as the <code>prev_wp</code></p></li><li><p>There is a flaw in the landing logic, where the bearing is locked, and the roll and yaw control is locked as it descends, since it takes <code>Vector2d curr_wp(pos_sp_curr.lat, pos_sp_curr.lon);</code> the current waypoint to be its one position, not the next setpoint that was given (<strong>this has to be changed!</strong>)</p></li></ul><table><thead><tr><th><img alt="Fixed Wing Landing QGC" src="/docusaurus/assets/images/landing_qgc-4bb497b421098d0041d86d6ef534eb06.png"></th><th><img alt="Fixed Wing Landing Terminal" src="/docusaurus/assets/images/landing_terminal-2700f82727efa381c7889446a58a9d64.png"></th></tr></thead></table><ul><li>The mavlink command from QGC is sent to <code>POSITION_TARGET_GLOBAL_INT</code> and it is under the <code>.lat_int</code>, <code>lon_int</code> and <code>alt</code> and the current position is under <code>GLOBAL_POSITION_INT</code> and the values for latitude, longitude and altitude is <code>lat</code>, <code>lon</code> and <code>alt</code>.</li></ul><table><thead><tr><th><img alt="Fixed Wing Mav Setpoints" src="/docusaurus/assets/images/mav_setpoints-033d7e10613228e0d697020dc05c26bb.png"></th></tr></thead></table><ul><li><p>After sending <code>commander land</code> the <code>NAV_CONTROLLER_OUTPUT.wp_dist</code> = 0 since it assumes the current position is the current waypoint, we need to implement the UAV to land with a specific global coordinates.  </p></li><li><p>The <code>Heading Hold</code> is activated after <code>Flare</code> hence the height is according to the <code>FW_LND_FLALT</code> height.</p></li><li><p><code>getLandingSlopeRelativeAltitudeSave</code> only activates and <strong>returns</strong> the <strong>slope altitude</strong> when the current bearing is close to the final bearing (<strong>desired</strong>)</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="initialization"></a>Initialization<a class="hash-link" href="#initialization" title="Direct link to heading">#</a></h2><p>The start of the function is to initialise the start and end points for the landing maneuver, the start would be the current position if <code>!pos_sp_prev.valid</code> and will use the current <code>longitude</code> and <code>latitude</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* current waypoint (the one currently heading for) */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Vector2d </span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Vector2d prev_wp</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* previous waypoint */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">prev_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">prev_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    * No valid previous waypoint, go for the current wp.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    * This is automatically handled by the L1 library.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">prev_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">prev_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="constrain-tecs"></a>Constrain TECS<a class="hash-link" href="#constrain-tecs" title="Direct link to heading">#</a></h3><p>The TECS would have a higher <code>_height_error_gain</code>, this is to have the UAV maintain the altitude on the course that PX4 has desired <code>_height_error_gain = 1.0f / math::max(time_const, 0.1f)</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Enable tighter altitude control for landings</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">_tecs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_height_error_time_constant</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_thrtc_sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> _param_fw_t_h_error_tc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="reset-logical-states"></a>Reset Logical States<a class="hash-link" href="#reset-logical-states" title="Direct link to heading">#</a></h3><p>We need to reset some of the logical states that help to govern the landing process</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// _time_started_landing = 0;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// reset terrain estimation relevant values</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// _time_last_t_alt = 0;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// _land_noreturn_horizontal = false;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// _land_noreturn_vertical = false;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// _land_stayonground = false;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// _land_motor_lim = false;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// _land_onslope = false;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">reset_landing_state</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">_time_started_landing </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="heading"></a>Heading<a class="hash-link" href="#heading" title="Direct link to heading">#</a></h3><p>Also we have to change the <strong>bearing</strong> of the airplane to face the bearing of the landing point <code>bearing_lastwp_currwp</code>. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> bearing_airplane_currwp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_bearing_to_next_waypoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> bearing_lastwp_currwp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bearing_airplane_currwp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// seems like the value is overwritten if there is a valid previous waypoint</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    bearing_lastwp_currwp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_bearing_to_next_waypoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">prev_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">prev_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="find-seperation-distance"></a>Find Seperation Distance<a class="hash-link" href="#find-seperation-distance" title="Direct link to heading">#</a></h3><p>Finding the distance to calculate for, which is the seperation distance.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Horizontal landing control */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* switch to heading hold for the last meters, continue heading hold after */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> wp_distance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_distance_to_next_waypoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* calculate a waypoint distance value which is 0 when the aircraft is behind the waypoint */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> wp_distance_save </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wp_distance</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">fabsf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">wrap_pi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bearing_airplane_currwp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> bearing_lastwp_currwp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">90.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    wp_distance_save </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="find-waypoint-offset"></a>Find Waypoint Offset<a class="hash-link" href="#find-waypoint-offset" title="Direct link to heading">#</a></h3><p>This is a helpful function to create a waypoint to track (<strong>virtual final destination</strong>), the plane will use the <code>pos_sp_prev</code> (if valid) to the <code>pos_sp_curr</code> </p><ul><li>Hence if we do not have <code>pos_sp_prev</code> and <code>pos_sp_curr</code>, the default is <code>pos_sp_prev = pos_sp_curr = current position</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// create virtual waypoint which is on the desired flight path but</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// some distance behind landing waypoint. This will make sure that the plane</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// will always follow the desired flight path even if we get close or past</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// the landing waypoint</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lon </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">create_waypoint_from_line_and_dist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1000.0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">curr_wp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lon</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="heading-hold-on-condition"></a>Heading Hold on Condition<a class="hash-link" href="#heading-hold-on-condition" title="Direct link to heading">#</a></h3><p>Tracking the desired flight path until UAV starts flaring, hence the bearing is not held until <strong>4</strong> conditions are stisfied according to PX4</p><ul><li><code>_param_fw_lnd_hhdist.get() &gt; 0.0f</code></li><li><code>!_land_noreturn_horizontal</code></li><li><code>((wp_distance &lt; _param_fw_lnd_hhdist.get()) ||_land_noreturn_vertical))</code></li></ul><p><strong>The Heading Hold is activated after Flare</strong></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><ul><li><code>_param_fw_lnd_hhdist.get()</code> or <code>FW_LND_HHDIST</code> = <strong>15m</strong> (default value)</li><li><code>FW_LND_FLALT</code> or flare altitude = <strong>3m</strong> (default value)</li><li><code>_land_noreturn_vertical</code> is activate when flaring phase just starts</li></ul></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// we want the plane to keep tracking the desired flight path until we start flaring</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// if we go into heading hold mode earlier then we risk to be pushed away from the runway by cross winds</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_lnd_hhdist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_land_noreturn_horizontal </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wp_distance </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> _param_fw_lnd_hhdist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">_land_noreturn_vertical</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* heading hold, along the line connecting this and the last waypoint */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _target_bearing </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bearing_lastwp_currwp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _target_bearing </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _yaw</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _land_noreturn_horizontal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mavlink_log_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_mavlink_log_pub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Landing, heading hold&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_land_noreturn_horizontal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// heading hold</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _l1_control</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">navigate_heading</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_target_bearing</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _yaw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ground_speed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// normal navigation</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _l1_control</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">navigate_waypoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prev_wp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> curr_wp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> curr_pos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ground_speed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">_att_sp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">roll_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _l1_control</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get_roll_setpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">_att_sp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">yaw_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _l1_control</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nav_bearing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_land_noreturn_horizontal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* limit roll motion to prevent wings from touching the ground first */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Limit to 10 degs */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _att_sp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">roll_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">constrain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_att_sp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">roll_body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">10.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="set-terrain-altitude"></a>Set Terrain Altitude<a class="hash-link" href="#set-terrain-altitude" title="Direct link to heading">#</a></h3><p>The terrain is initialised to help tell TECS and the controller what is the height difference, the logical sequence here is valid for <strong>terrain sensor (range sensors)</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// default to no terrain estimation, just use landing waypoint altitude</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> terrain_alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_lnd_useter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_local_pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dist_bottom_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// all good, have valid terrain altitude</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> terrain_vpos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _local_pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dist_bottom </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> _local_pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        terrain_alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_local_pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ref_alt </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> terrain_vpos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _t_alt_prev_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> terrain_alt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _time_last_t_alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_time_last_t_alt </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// we have started landing phase but don&#x27;t have valid terrain</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// wait for some time, maybe we will soon get a valid estimate</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// until then just use the altitude of the landing waypoint</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _time_started_landing</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">_s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            terrain_alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// still no valid terrain, abort landing</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            terrain_alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_curr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">abort_landing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_local_pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dist_bottom_valid </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _time_last_t_alt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> T_ALT_TIMEOUT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> _land_noreturn_vertical</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// use previous terrain estimate for some time and hope to recover</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// if we are already flaring (land_noreturn_vertical) then just</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//  go with the old estimate</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        terrain_alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _t_alt_prev_valid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// terrain alt was not valid for long time, abort landing</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        terrain_alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _t_alt_prev_valid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">abort_landing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="controls"></a>Controls<a class="hash-link" href="#controls" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fw-descend"></a>FW Descend<a class="hash-link" href="#fw-descend" title="Direct link to heading">#</a></h3><p>We will evaluate the <code>else</code> portion which is the descending of the UAV, following what PX4 has mentioned about unwanted climbout (<code>checking for land_noreturn to avoid unwanted climb out</code>).</p><ul><li><p><code>altitude_desired = terrain_alt + landing_slope_alt_rel_desired;</code> ensures the UAV stays on the slope.</p></li><li><p>After which <code>_land_onslope = true</code> and the UAV will follow the altitude desired for the next timestep and this will be passed to the <strong>TECS controller</strong></p></li><li><p><code>tecs_update_pitch_throttle()</code> will publish <code>_tecs_status_pub.publish(t)</code> so tecs will control <strong>pitch</strong> and <strong>throttle</strong>.</p></li><li><p><code>wp_distance</code> distance from current to final waypoint.</p></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current_altitude </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> terrain_alt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> _landingslope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">flare_relative_alt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _land_noreturn_vertical</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//checking for land_noreturn to avoid unwanted climb out</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* intersect glide slope:</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        * minimize speed to approach speed</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        * if current position is higher than the slope follow the glide slope (sink to the</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        * glide slope)</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        * also if the system captures the slope it should stay</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        * on the slope (bool land_onslope)</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        * if current position is below the slope continue at previous wp altitude</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        * until the intersection with slope</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        * */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> altitude_desired </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> terrain_alt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> landing_slope_alt_rel_desired </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _landingslope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLandingSlopeRelativeAltitudeSave</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        wp_distance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        bearing_lastwp_currwp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        bearing_airplane_currwp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current_altitude </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> terrain_alt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> landing_slope_alt_rel_desired </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> _land_onslope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* stay on slope */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        altitude_desired </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> terrain_alt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> landing_slope_alt_rel_desired</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_land_onslope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">mavlink_log_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_mavlink_log_pub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Landing, on slope&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _land_onslope </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* continue horizontally */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            altitude_desired </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pos_sp_prev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            altitude_desired </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _current_altitude</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> airspeed_approach </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _param_fw_lnd_airspd_sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> _param_fw_airspd_min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">tecs_update_pitch_throttle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        now</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        altitude_desired</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">calculate_target_airspeed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">airspeed_approach</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ground_speed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_p_lim_min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_p_lim_max</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _param_fw_thr_min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _param_fw_thr_max</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _param_fw_thr_cruise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_p_lim_min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fw-flare"></a>FW Flare<a class="hash-link" href="#fw-flare" title="Direct link to heading">#</a></h3><p>Condition to activate flare is <code>(_current_altitude &lt; terrain_alt + _landingslope.flare_relative_alt())</code> this is when the current altitude low enough to activate the flare which is around <code>FW_LND_FLALT</code> height.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current_altitude </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> terrain_alt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> _landingslope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">flare_relative_alt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _land_noreturn_vertical</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* land with minimal speed */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* force TECS to only control speed with pitch, altitude is only implicitly controlled now */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// _tecs.set_speed_weight(2.0f);</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* kill the throttle if param requests it */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> throttle_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _param_fw_thr_max</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* enable direct yaw control using rudder/wheel */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_land_noreturn_horizontal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _att_sp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">yaw_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _target_bearing</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _att_sp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fw_control_yaw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current_altitude </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> terrain_alt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> _landingslope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">motor_lim_relative_alt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wp_distance_save </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> _landingslope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">flare_length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Only kill throttle when close to WP</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _land_motor_lim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throttle_max </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">throttle_max</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _param_fw_thr_lnd_max</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_land_motor_lim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _land_motor_lim  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">mavlink_log_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_mavlink_log_pub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Landing, limiting throttle&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> flare_curve_alt_rel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _landingslope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getFlareCurveRelativeAltitudeSave</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wp_distance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bearing_lastwp_currwp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    bearing_airplane_currwp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* avoid climbout */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_flare_curve_alt_rel_last </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> flare_curve_alt_rel </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> _land_noreturn_vertical</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> _land_stayonground</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        flare_curve_alt_rel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// stay on ground</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _land_stayonground </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> airspeed_land </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _param_fw_lnd_airspd_sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> _param_fw_airspd_min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> throttle_land </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _param_fw_thr_min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_thr_max</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _param_fw_thr_min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">tecs_update_pitch_throttle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        now</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        terrain_alt </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> flare_curve_alt_rel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">calculate_target_airspeed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">airspeed_land</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ground_speed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_lnd_fl_pmin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_lnd_fl_pmax</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throttle_max</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throttle_land</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _land_motor_lim </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_lnd_fl_pmin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_p_lim_min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _land_motor_lim </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> tecs_status_s</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">TECS_MODE_LAND_THROTTLELIM </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> tecs_status_s</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">TECS_MODE_LAND</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_land_noreturn_vertical</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// just started with the flaring phase</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _flare_pitch_sp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_psp_off</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _flare_height </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _current_altitude </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> terrain_alt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">mavlink_log_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_mavlink_log_pub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Landing, flaring&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        _land_noreturn_vertical </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_local_pos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vz </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _flare_pitch_sp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_param_fw_lnd_fl_pmin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">constrain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_flare_height </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_current_altitude </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> terrain_alt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> _flare_height</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// otherwise continue using previous _flare_pitch_sp</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _att_sp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pitch_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _flare_pitch_sp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _flare_curve_alt_rel_last </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flare_curve_alt_rel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="helper-functions"></a>Helper Functions<a class="hash-link" href="#helper-functions" title="Direct link to heading">#</a></h2><p><code>get_bearing_to_next_waypoint</code> can be found in the <code>geo.cpp</code> under <code>ecl/geo.cpp</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_bearing_to_next_waypoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lat_now</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lon_now</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lat_next</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lon_next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lat_now_rad </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> math</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat_now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lat_next_rad </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> math</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat_next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> cos_lat_next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat_next_rad</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> d_lon </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> math</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lon_next </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> lon_now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* conscious mix of double and float trig function to maximize speed and efficiency */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d_lon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cos_lat_next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static_cast</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">cos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat_now_rad</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat_next_rad</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat_now_rad</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cos_lat_next </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d_lon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wrap_pi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">atan2f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>wrap_pi</code> can be found in the <code>matrix/matrix/helper_functions.hpp</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">M_PI</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">3.14159265358979323846</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/**</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Wrap value in range [-π, π)</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">template</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">Type</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Type </span><span class="token function" style="color:#d73a49">wrap_pi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Type x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">M_PI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M_PI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>getLandingSlopeRelativeAltitudeSave</code> can be found in the directory <code>landing_slope/Landingslope.cpp</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">float</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Landingslope</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getLandingSlopeRelativeAltitudeSave</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> wp_landing_distance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> bearing_lastwp_currwp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> bearing_airplane_currwp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* If airplane is in front of waypoint return slope altitude, else return waypoint altitude */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">fabsf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">matrix</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">wrap_pi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bearing_airplane_currwp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> bearing_lastwp_currwp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> math</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">radians</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">90.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getLandingSlopeRelativeAltitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wp_landing_distance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>getLandingSlopeRelativeAltitude</code> can be found in the directory <code>landing_slope/Landingslope.cpp</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @return Relative altitude of point on landing slope at distance to landing waypoint=wp_landing_distance</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> </span><span class="token class-name">Landingslope</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getLandingSlopeRelativeAltitude</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> wp_landing_distance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> horizontal_slope_displacement</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> landing_slope_angle_rad</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// flare_relative_alt is negative</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wp_landing_distance </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> horizontal_slope_displacement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tanf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">landing_slope_angle_rad</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/px4-autopilot/fixedwing/land.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-07-29T02:22:57.000Z">7/29/2021</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docusaurus/docs/px4-autopilot/introduction/intro"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Introduction</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#code-review" class="table-of-contents__link">Code Review</a></li><li><a href="#findings" class="table-of-contents__link">Findings</a></li><li><a href="#initialization" class="table-of-contents__link">Initialization</a><ul><li><a href="#constrain-tecs" class="table-of-contents__link">Constrain TECS</a></li><li><a href="#reset-logical-states" class="table-of-contents__link">Reset Logical States</a></li><li><a href="#heading" class="table-of-contents__link">Heading</a></li><li><a href="#find-seperation-distance" class="table-of-contents__link">Find Seperation Distance</a></li><li><a href="#find-waypoint-offset" class="table-of-contents__link">Find Waypoint Offset</a></li><li><a href="#heading-hold-on-condition" class="table-of-contents__link">Heading Hold on Condition</a></li><li><a href="#set-terrain-altitude" class="table-of-contents__link">Set Terrain Altitude</a></li></ul></li><li><a href="#controls" class="table-of-contents__link">Controls</a><ul><li><a href="#fw-descend" class="table-of-contents__link">FW Descend</a></li><li><a href="#fw-flare" class="table-of-contents__link">FW Flare</a></li></ul></li><li><a href="#helper-functions" class="table-of-contents__link">Helper Functions</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docusaurus/docs/unity/introduction/intro">Introduction</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docusaurus/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Built with Docusaurus.</div></div></div></footer></div>
<script src="/docusaurus/assets/js/runtime~main.be60e350.js"></script>
<script src="/docusaurus/assets/js/main.715702e2.js"></script>
</body>
</html>